
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Solr Tutorial - Kevin Doran</title>
  <meta name="author" content="Kevin Doran">

  
  <meta name="description" content="Solr Tutorial written Jun 4th, 2014 I recently had the need to search a large amount of online auction data. I had access to the data associated &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://kevindoran.github.io/blog/2014/06/04/solr-tutorial">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Kevin Doran" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<script type="text/javascript" src="//use.typekit.net/jyo0fhs.js"></script>
<script type="text/javascript">try{Typekit.load();}catch(e){}</script>
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-49527422-5', 'kevindoran.co');
  ga('send', 'pageview');

</script>


</head>

  <body>
    <a href="/" class="home-icon">
      <img src="/images/home.png"/>
    </a>

    <article role="article" class="full-single-article">
  <div class="container">
    <div class="row">
      <div class="col-md-8 col-md-offset-2">
        <h1>Solr Tutorial</h1>
        <div class="meta">
          written 








  



<time datetime="2014-06-04T12:15:47+12:00" pubdate data-updated="true">Jun 4<span>th</span>, 2014</time>
          


        </div>
        <p>
	I recently had the need to search a large amount of online auction data. I had access to the data associated with a large number of online auctions, similar to auctions on eBay. I needed to quickly find auctions whose title and description match a given set of search terms. My solution was to use <a href="http://en.wikipedia.org/wiki/Apache_Solr" target="_blank">Solr</a>, an open source search application/platform.&nbsp; This post describes the steps I carried out to set-up Solr, and the difficulties encountered along the way. The post covers Solr 4.8. <br />
</p>
<!-- more -->
<p>
	The decision to use Solr was based on the need for a fast and customisable mechanism to search for auctions. Initially, MySQL&#8217;s <a href="http://dev.mysql.com/doc/refman/5.7/en/fulltext-search.html" target="_blank">fulltext search</a> was used. This was slow, inflexible and had a number of issues such as not recognising numbers or common words.<br />
</p>

<h2>Overview of Solr operation</h2>
<p>
	Solr behaves in many ways like a web server such as Apache: once started, Solr uses the data in its installation directory to serve responses to client requests. The major difference is that Solr is serving search results (in XML, JSON or other formats) as opposed to web pages. The Solr installation is completely standalone: the Solr directory contains everything needed to start and run the server, including a Java Servlet container and all the application data. Solr is controlled using configuration files. Four files in particular play an important role:<code>solr.xml</code>, <code>solrconfig.xml</code>, <code>schema.xml</code> and <code>solr-data-config.xml</code> (schema.xml and solr-data-config.xml can have custom names).<br />
</p>

<h2>Starting Solr</h2>
<p>
	To start Solr in its default state, navigate to:
	<code class="code-block">
		apache-solr-X.X.X/example/</code>
	and run:
	<br />
	<code class="code-block"> 
		java -jar start.jar
	</code>
	This starts the server and sets Solr to use the default home directory, <code>./solr</code>.
</p>

<p>
	When making your own Solr instance, it is a good idea to start by copying the default Solr directory, name it as you wish, and start working with this new Solr instance. 
	Assuming I call my Solr directory <code>AuctionSearch</code>, to start Solr after making the new directory, run:
	<br />
	<code class="code-block">
		java -jar start.jar -Dsolr.solr.home=AuctionSearch
	</code>
	After running this command, you can browse to <a href="http://localhost:8983/solr/">http://localhost:8983/solr/</a> to view the administration user interface. The default Solr instance doesn&#8217;t have any documents indexed (or it might have just one), so there wont be much to tinker with until more documents are added. Before adding documents, however, some configuration will probably be needed.
</p>

<h2>Configuring Solr</h2>
<p>
	Configuring Solr is not typically done once- instead a cycle of 
	configuring and testing is carried out. Even months after I initially 
	set up Solr to work for my application, I am still tweaking it as I 
	learn more about Solr and learn more about my data. Despite this cyclic 
	nature, the configuration of Solr will be described here in a linear fashion. 
	However, jumping between sections is encouraged. In turn, the following will be discussed:
</p>
<ul>
	<li><code>solr.xml</code> Solr cores</li>
	<li><code>schema.xml</code> Document structure</li>
	<li><code>solrconfig.xml</code> Request handlers</li>
</ul>

<p>
	When configuring Solr, it is helpful to have a picture of the Solr home directory structure, and to know where all the configuration files are located. The image below shows important configuration files within the example Solr directory.
</p>
<img id="solrDirectory" class='img-responsive' src="/images/solrDirectoryStructure.jpg" alt="Solr Directory Structure"/>

<h2>Solr cores</h2>
<p>
	A Solr core manages a single <em>index</em>. An index is the set of all data used to store information about documents to be searched. Each index can have only one document schema associated with it (only one document format can be stored). Using multiple cores allows a single Solr instance (single server, single administration web page) to manage multiple indexes. A use case (context: auction website) for this might be having one core for indexing auction data and another for indexing information on users. Each core will have its own core directory. 
	Cores are configured in <code>solr.xml</code>. An example <code>solr.xml</code>:<br />
</p>

<figure class='code'><figcaption><span>solr.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="c">&lt;!-- persistent=&quot;true&quot; allows the web interface to make lasting changes to Solr. --&gt;</span>
</span><span class='line'><span class="nt">&lt;solr</span> <span class="na">persistent=</span><span class="s">&quot;true&quot;</span> <span class="na">sharedlib=</span><span class="s">&quot;lib&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;cores</span> <span class="na">adminpath=</span><span class="s">&quot;/admin/cores&quot;</span> <span class="na">host=</span><span class="s">&quot;${host:}&quot;</span> <span class="na">hostcontext=</span><span class="s">&quot;${hostContext:}&quot;</span> <span class="na">hostport=</span><span class="s">&quot;${jetty.port:}&quot;</span> <span class="na">zkclienttimeout=</span><span class="s">&quot;${zkClientTimeout:15000}&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;core</span> <span class="na">default=</span><span class="s">&quot;true&quot;</span> <span class="na">instancedir=</span><span class="s">&quot;auctions&quot;</span> <span class="na">name=</span><span class="s">&quot;auctions&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/core&gt;&lt;/cores&gt;</span>
</span><span class='line'><span class="nt">&lt;/solr&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>
	Usually, the default <code>solr.xml</code> is sufficient. You may want to change the core names and core directory names. <a href="https://cwiki.apache.org/confluence/display/solr/Solr+Cores+and+solr.xml" target="_blank">Further details</a> on configuring <code>solr.xml</code>.
</p>
<p>
	In Solr 4.3 and above, <code>solr.xml</code> has a <a href="https://cwiki.apache.org/confluence/display/solr/Format+of+solr.xml">new purpose and a new format</a>. In Solr 5.0 and above, the older format will not be supported. 
</p>

<h2>Schema</h2>
<p>
	A Solr schema describes the basic unit of information: a <em>document</em>. Each Solr core has a single schema, and thus, indexes only one &#8216;form&#8217; of document. A document is composed of multiple <em>fields</em>. Each field has a <em>type</em>. This type is defined in the schema and specifies the underlying Java class that is created when the field is indexed. The type also specifies the text analysis (processing/digestion) that is carried out when the field is indexed. An example document and a section of the corresponding <code>schema.xml</code> is shown below.
</p>

<figure class='code'><figcaption><span>exampleSolrDoc.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;doc&gt;</span>
</span><span class='line'>    <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;auction_id&quot;</span><span class="nt">&gt;</span>54432834<span class="nt">&lt;/field&gt;</span>
</span><span class='line'>    <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;title&quot;</span><span class="nt">&gt;</span>Dell M2012 24&quot; IPS Monitor<span class="nt">&lt;/field&gt;</span>
</span><span class='line'>    <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;category&quot;</span><span class="nt">&gt;</span>monitors<span class="nt">&lt;/field&gt;</span>
</span><span class='line'>    <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;current_bid&quot;</span><span class="nt">&gt;</span>279.95<span class="nt">&lt;/field&gt;</span>
</span><span class='line'>    <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;end_date&quot;</span><span class="nt">&gt;</span>2013-01-06T09:26:04.18Z<span class="nt">&lt;/field&gt;</span>
</span><span class='line'>    <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;feature&quot;</span><span class="nt">&gt;</span>IPS<span class="nt">&lt;/field&gt;</span>
</span><span class='line'>    <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;feature&quot;</span><span class="nt">&gt;</span>Swivel<span class="nt">&lt;/field&gt;</span>
</span><span class='line'><span class="nt">&lt;/doc&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<br />
<figure class='code'><figcaption><span>schema.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;schema</span> <span class="na">name=</span><span class="s">&quot;example&quot;</span> <span class="na">version=</span><span class="s">&quot;1.5&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;fields&gt;</span>
</span><span class='line'>        <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;_version_&quot;</span> <span class="na">type=</span><span class="s">&quot;long&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">required=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;auction_id&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">required=</span><span class="s">&quot;true&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;title&quot;</span> <span class="na">type=</span><span class="s">&quot;text_en&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">required=</span><span class="s">&quot;true&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;category&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">required=</span><span class="s">&quot;true&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;current_bid&quot;</span> <span class="na">type=</span><span class="s">&quot;currency&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">required=</span><span class="s">&quot;true&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;end_date&quot;</span> <span class="na">type=</span><span class="s">&quot;date&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">required=</span><span class="s">&quot;true&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;feature&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">required=</span><span class="s">&quot;false&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/fields&gt;</span>
</span><span class='line'>    <span class="nt">&lt;uniqueKey&gt;</span>auction_id<span class="nt">&lt;/uniqueKey&gt;</span>
</span><span class='line'>    <span class="nt">&lt;types&gt;</span>
</span><span class='line'>        <span class="nt">&lt;fieldType</span> <span class="na">name=</span><span class="s">&quot;string&quot;</span> <span class="na">class=</span><span class="s">&quot;solr.StrField&quot;</span> <span class="na">sortMissingLast=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;fieldType</span> <span class="na">name=</span><span class="s">&quot;date&quot;</span> <span class="na">class=</span><span class="s">&quot;solr.TrieDateField&quot;</span> <span class="na">precisionStep=</span><span class="s">&quot;0&quot;</span> <span class="na">positionIncrementGap=</span><span class="s">&quot;0&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;fieldType</span> <span class="na">name=</span><span class="s">&quot;long&quot;</span> <span class="na">class=</span><span class="s">&quot;solr.TrieLongField&quot;</span> <span class="na">precisionStep=</span><span class="s">&quot;0&quot;</span> <span class="na">positionIncrementGap=</span><span class="s">&quot;0&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;fieldType</span> <span class="na">name=</span><span class="s">&quot;text_en&quot;</span> <span class="na">class=</span><span class="s">&quot;solr.TextField&quot;</span> <span class="na">positionIncrementGap=</span><span class="s">&quot;100&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="c">&lt;!-- lots of details --&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/fieldType&gt;</span>
</span><span class='line'>        <span class="nt">&lt;fieldType</span> <span class="na">name=</span><span class="s">&quot;currency&quot;</span> <span class="na">class=</span><span class="s">&quot;solr.CurrencyField&quot;</span> <span class="na">precisionStep=</span><span class="s">&quot;8&quot;</span> <span class="na">defaultCurrency=</span><span class="s">&quot;USD&quot;</span> <span class="na">currencyConfig=</span><span class="s">&quot;currency.xml&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/types&gt;</span>
</span><span class='line'><span class="nt">&lt;/schema&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>
	The components of schema.xml will now be described.
</p>

<h3>Fields</h3>
<p>
	A field describes a piece of information within a document. It controls aspects of the indexing process such as what Java type is used to represent the data, whether the data is stored, whether the field is required in every document etc. There are two types of special fields: <em>copyField</em> and <em>dynamicField</em> (not to be confused with the type parameter such as type=&#8221;string&#8221;). 
</p>
<dl>
	<dt>copyField</dt>
	<dd>Copy fields allow you to index a field in more than one way. A field is copied allowing different field types, such as <code>text_en</code> or <code>string</code> to be applied to the single piece of information.</dd>
	<dt>dynamicField</dt>
	<dd>Dynamic fields are, in a way, an inverse to copying fields; they allow you to process multiple fields in the same way. Their most useful feature is their ability to match document fields with pattern matching. A common usage of dynamic fields is to catch all fields in a document which should not be indexed. This is required, as when fields are indexed, all document fields must be processed, or an error is thrown.</dd>
</dl>
<p>
	An example of using copy and dynamic fields is show below:
</p>
<figure class='code'><figcaption><span>schema</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;schema</span> <span class="na">name=</span><span class="s">&quot;example&quot;</span> <span class="na">version=</span><span class="s">&quot;1.5&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;fields&gt;</span>
</span><span class='line'>        <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;title&quot;</span> <span class="na">type=</span><span class="s">&quot;text_en&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">required=</span><span class="s">&quot;true&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;category&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">required=</span><span class="s">&quot;true&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;feature&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">required=</span><span class="s">&quot;false&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;allText&quot;</span> <span class="na">type=</span><span class="s">&quot;text_en&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span> <span class="na">stored=</span><span class="s">&quot;false&quot;</span> <span class="na">required=</span><span class="s">&quot;true&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/fields&gt;</span>
</span><span class='line'>    <span class="nt">&lt;copyField</span> <span class="na">source=</span><span class="s">&quot;title&quot;</span> <span class="na">dest=</span><span class="s">&quot;allText&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;copyField</span> <span class="na">source=</span><span class="s">&quot;category&quot;</span> <span class="na">dest=</span><span class="s">&quot;allText&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;copyField</span> <span class="na">source=</span><span class="s">&quot;feature&quot;</span> <span class="na">dest=</span><span class="s">&quot;allText&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;dynamicField</span> <span class="na">name=</span><span class="s">&quot;*&quot;</span> <span class="na">type=</span><span class="s">&quot;ignored&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/schema&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<h3>Analysers, tokenisers and filters</h3>
<p>
Each field has a type, and each type is defined by a set of analysers (which are made up of tokenizers and filters). 
</p>
<dl>
	<dt>Analyser</dt>
	<dd>An analyzer converts the text of a field and modifies it to form the 
		text that is indexed. Analyzers are made up of one or more tokenizer 
		and/or filter.  Seeing as analyzers are 
		constructed from filters and tokenizers in an adhoc manor, they don&#8217;t 
		really have a name; they will just be identified by the <code>fieldType</code> where
		they are defined.</dd>
	<dt>Tokenizer</dt>
	<dd>A tokenizer breaks up a stream of text into units, called tokens. For example, the text: &#8220;Please like my blog&#8221;, might be passed through a filter to produce the 4 tokens: (Please, like, my, blog) or using another type of tokenizer: (p, l, e, a, s, e, l, i, k, e, m, y, b, l, o, g).</dd>
	<dt>Filter</dt>
	<dd>Filters take in tokens, transform them, and output the transformed tokens (they can modify or discard them). A example: a filter which converts all text to lowercase.</dd>
</dl>
<p>
	A useful note: analyzers can operate both at index time and at query time. In other words, they transform both the documents that are indexed and the search terms that are used by a user.
</p>

<p>
	A reasonably complex analyzer is shown below. It is defined in the example Solr <code>schema.xml</code> file for the <code>fieldType</code> text_en:
</p>
<figure class='code'><figcaption><span>schemaPart.xml </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;fieldType</span> <span class="na">name=</span><span class="s">&quot;text_en&quot;</span> <span class="na">class=</span><span class="s">&quot;solr.TextField&quot;</span> <span class="na">positionIncrementGap=</span><span class="s">&quot;100&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>	<span class="nt">&lt;analyzer</span> <span class="na">type=</span><span class="s">&quot;index&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>		<span class="nt">&lt;tokenizer</span> <span class="na">class=</span><span class="s">&quot;solr.StandardTokenizerFactory&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>		<span class="nt">&lt;filter</span> <span class="na">class=</span><span class="s">&quot;solr.StopFilterFactory&quot;</span>
</span><span class='line'>			<span class="na">ignoreCase=</span><span class="s">&quot;true&quot;</span>
</span><span class='line'>			<span class="na">words=</span><span class="s">&quot;lang/stopwords_en.txt&quot;</span>
</span><span class='line'>			<span class="na">enablePositionIncrements=</span><span class="s">&quot;true&quot;</span>
</span><span class='line'>			<span class="nt">/&gt;</span>
</span><span class='line'>		<span class="nt">&lt;filter</span> <span class="na">class=</span><span class="s">&quot;solr.LowerCaseFilterFactory&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>		<span class="nt">&lt;filter</span> <span class="na">class=</span><span class="s">&quot;solr.EnglishPossessiveFilterFactory&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>		<span class="nt">&lt;filter</span> <span class="na">class=</span><span class="s">&quot;solr.KeywordMarkerFilterFactory&quot;</span> <span class="na">protected=</span><span class="s">&quot;protwords.txt&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>		<span class="nt">&lt;filter</span> <span class="na">class=</span><span class="s">&quot;solr.PorterStemFilterFactory&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>	<span class="nt">&lt;/analyzer&gt;</span>
</span><span class='line'>	<span class="nt">&lt;analyzer</span> <span class="na">type=</span><span class="s">&quot;query&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>		<span class="nt">&lt;tokenizer</span> <span class="na">class=</span><span class="s">&quot;solr.StandardTokenizerFactory&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>		<span class="nt">&lt;filter</span> <span class="na">class=</span><span class="s">&quot;solr.SynonymFilterFactory&quot;</span> <span class="na">synonyms=</span><span class="s">&quot;synonyms.txt&quot;</span> <span class="na">ignoreCase=</span><span class="s">&quot;true&quot;</span> <span class="na">expand=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>		<span class="nt">&lt;filter</span> <span class="na">class=</span><span class="s">&quot;solr.StopFilterFactory&quot;</span>
</span><span class='line'>			<span class="na">ignoreCase=</span><span class="s">&quot;true&quot;</span>
</span><span class='line'>			<span class="na">words=</span><span class="s">&quot;lang/stopwords_en.txt&quot;</span>
</span><span class='line'>			<span class="na">enablePositionIncrements=</span><span class="s">&quot;true&quot;</span>
</span><span class='line'>			<span class="nt">/&gt;</span>
</span><span class='line'>		<span class="nt">&lt;filter</span> <span class="na">class=</span><span class="s">&quot;solr.LowerCaseFilterFactory&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>		<span class="nt">&lt;filter</span> <span class="na">class=</span><span class="s">&quot;solr.EnglishPossessiveFilterFactory&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>		<span class="nt">&lt;filter</span> <span class="na">class=</span><span class="s">&quot;solr.KeywordMarkerFilterFactory&quot;</span> <span class="na">protected=</span><span class="s">&quot;protwords.txt&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>		<span class="nt">&lt;filter</span> <span class="na">class=</span><span class="s">&quot;solr.PorterStemFilterFactory&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>	<span class="nt">&lt;/analyzer&gt;</span>
</span><span class='line'><span class="nt">&lt;/fieldType&gt;</span>
</span></code></pre></td></tr></table></div></figure>
<h2>Schema Snares</h2>
<p>
There are two issues I encountered when creating a schema for which I had trouble finding information online. Consider coming back to this section if you have issues. 
</p>
<h3>Multivalued Fields</h3>
<p>
Multivalued refers to the possibility of their being two values for present in the same document for a single field. For example, for the document shown below, there is always only one title. An example of a multivalued field is the feature field, this can have many values in a single document. What is important to realise when using multivalued fields, is that the data gets flattened. If an auction has 2 features, then the two features get flattened such that the relationship between the name and the value of the feature is lost. 
</p>

<figure class='code'><figcaption><span>schemaPart.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="c">&lt;!-- What an auction might look like in its original XML form: --&gt;</span>
</span><span class='line'><span class="nt">&lt;auction&gt;</span>
</span><span class='line'>	<span class="nt">&lt;title&gt;</span>Desktop PC<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>	<span class="nt">&lt;feature&gt;</span>
</span><span class='line'>		<span class="nt">&lt;name&gt;</span>RAM<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>		<span class="nt">&lt;value&gt;</span>16 GB<span class="nt">&lt;/value&gt;</span>
</span><span class='line'>	<span class="nt">&lt;/feature&gt;</span>
</span><span class='line'>	<span class="nt">&lt;feature&gt;</span>
</span><span class='line'>		<span class="nt">&lt;name&gt;</span>CPU Frequency<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>		<span class="nt">&lt;value&gt;</span>4.5 GHz<span class="nt">&lt;/value&gt;</span>
</span><span class='line'>	<span class="nt">&lt;/feature&gt;</span>
</span><span class='line'><span class="nt">&lt;/auction&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c">&lt;!-- What an auction would look like as a Solr document: --&gt;</span>
</span><span class='line'><span class="nt">&lt;doc&gt;</span>
</span><span class='line'>	<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;title&quot;</span><span class="nt">&gt;</span>Desktop PC<span class="nt">&lt;/field&gt;</span>
</span><span class='line'>	<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;feature_name&quot;</span><span class="nt">&gt;</span>RAM<span class="nt">&lt;/field&gt;</span>
</span><span class='line'>	<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;feature_value&quot;</span><span class="nt">&gt;</span>16 GB<span class="nt">&lt;/field&gt;</span>
</span><span class='line'>	<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;feature_name&quot;</span><span class="nt">&gt;</span>CPU Frequency<span class="nt">&lt;/field&gt;</span>
</span><span class='line'>	<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;feature_value&quot;</span><span class="nt">&gt;</span>4.5 GHz<span class="nt">&lt;/field&gt;</span>
</span><span class='line'><span class="nt">&lt;/doc&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c">&lt;!-- The *effect* of multivalued field flattening: --&gt;</span>
</span><span class='line'><span class="nt">&lt;doc&gt;</span>
</span><span class='line'>	<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;title&quot;</span><span class="nt">&gt;</span>Desktop PC<span class="nt">&lt;/field&gt;</span>
</span><span class='line'>	<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;feature_name&quot;</span><span class="nt">&gt;</span>RAM CPU Frequency<span class="nt">&lt;/field&gt;</span>
</span><span class='line'>	<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;feature_value&quot;</span><span class="nt">&gt;</span>16 GB 4.5 GHz<span class="nt">&lt;/field&gt;</span>
</span><span class='line'><span class="nt">&lt;/doc&gt;</span>
</span></code></pre></td></tr></table></div></figure>
<p>
	By observing the way the data is indexed, it is clear that the relationship between the name and value pairs is lost. In other words, one to many relationships cannot be maintained by Solr in a single index (the is an exotic method of using multiple indexes and multiple cores). From a relational database point of view, Solr flattens all data into a single &#8216;table&#8217;.
</p>

<h3>PolyFields</h3>
<p>
	A ployfield, such as the <code>Currency</code> field, is a field that requires more than one value to be stored when it is indexed. The currency field needs to store both the amount of money and the currency of the money. Polyfields <em>must</em> have <code>stored=true</code>, or errors will result.
</p>

<h2>solrconfig.xml</h2>
<p>
	<code>solrconfig.xml</code> is used to configure many aspects of Solr&#8217;s operation, for example, it is used to configure:
</p>
<ul>
	<li>request handlers</li>
	<li>listeners (listen for requests sent to handlers) </li>
	<li>admin interface</li>
	<li>replication and duplication</li>
</ul>
<p>
	Typically, the only changes that need to be made to <code>solrconfig.xml</code> are to add or alter search and index request handlers. These two examples will be covered in the Indexing and Searching sections respectively. 
</p>

<h2>Indexing data</h2>
<p>
There two difficult issues I encountered for which it can be hard to uncover the cause of the problem. This section can be skipped and returned to if issues arise.
</p>
<p>
	There are two ways I have used to add documents to an index: posting XML 
	to a request handler or importing it from a database. All the data I index is also stored in a database. I initially carry out a data import from a database to catch up on the 
	database from an empty state. Once this import is finished, new 
	documents are added to the index by sending the documents in XML form to Solr via HTTP post.
</p>

<h3>Importing from a database</h3>
<p>
	Importing data from a database in carried out using the <a href="https://cwiki.apache.org/confluence/display/solr/Uploading+Structured+Data+Store+Data+with+the+Data+Import+Handler" target="_blank">Data Import Handler</a> 
	(DIH). To use the DIH, a configuration file must be created to direct 
	the conversion. In addition to the configuration file, a request handler must be specified in <code>solrconfig.xml</code> for the DIH. The details of writing the configuration file is given in the above link.
</p>

<h3>Posting XML</h3>
<p>
	Once Solr has indexed the entire database, new documents are added by posting them to a Solr request handler. <a href="https://wiki.apache.org/solr/Solrj" target="_blank">SolrJ</a>, a Java API for Solr, is used to do the posting. Solr comes with a simple request handler for adding documents by posting XML. It is defined in solrconfig.xml as follows:
</p>
<figure class='code'><figcaption><span>solrconfigPart.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="c">&lt;!-- in solrconfig.xml --&gt;</span>
</span><span class='line'><span class="nt">&lt;requestHandler</span> <span class="na">name=</span><span class="s">&quot;/update&quot;</span> <span class="na">class=</span><span class="s">&quot;solr.UpdateRequestHandler&quot;</span> <span class="nt">/&gt;</span>
</span></code></pre></td></tr></table></div></figure>
<p>
	Thus, by sending XML to the URL <a href="http://localhost:8983/solr/coreName/update">http://localhost:8983/solr/coreName/update</a>, Solr will add the document to the index. Unfortunately, in most situations, if you already have XML data which you want to index, it probably wont exist in the format that Solr expects. For example, compare the following:
</p>
<figure class='code'><figcaption><span>comparison.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="c">&lt;!-- original XML format: --&gt;</span>
</span><span class='line'><span class="nt">&lt;auction&gt;</span>
</span><span class='line'>	<span class="nt">&lt;auction_id&gt;</span>54432834<span class="nt">&lt;/auction_id&gt;</span>
</span><span class='line'>	<span class="nt">&lt;title&gt;</span>Dell M2012 24&quot; IPS Monitor<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>	<span class="nt">&lt;category&gt;</span>monitors<span class="nt">&lt;/category&gt;</span>
</span><span class='line'>	<span class="nt">&lt;current_bid&gt;</span>279.95<span class="nt">&lt;/current_bid&gt;</span>
</span><span class='line'><span class="nt">&lt;/auction&gt;</span>
</span><span class='line'><span class="c">&lt;!-- The format Solr requires: --&gt;</span>
</span><span class='line'><span class="nt">&lt;doc&gt;</span>
</span><span class='line'>	<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;auction_id&quot;</span><span class="nt">&gt;</span>54432834<span class="nt">&lt;/field&gt;</span>
</span><span class='line'>	<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;title&quot;</span><span class="nt">&gt;</span>Dell M2012 24&quot; IPS Monitor<span class="nt">&lt;/field&gt;</span>
</span><span class='line'>	<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;category&quot;</span><span class="nt">&gt;</span>monitors<span class="nt">&lt;/field&gt;</span>
</span><span class='line'>	<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;current_bid&quot;</span><span class="nt">&gt;</span>279.95<span class="nt">&lt;/field&gt;</span>
</span><span class='line'><span class="nt">&lt;/doc&gt;</span>
</span></code></pre></td></tr></table></div></figure>
<p>
	Thus, there is a need to convert the original XML into the form which Solr expects. There are two ways to do this conversion:
</p>
<ol class='detailed-list'>
	<li> In Java: JAXP API can be used to carry out the conversion. This will require writing custom code to do the conversion. Alternatively, if your data exists as Java classes, you can index those through SolrJ, which has a persistence mechanism allowing Java objects to be indexed directly. </li>
	<li> Use XSLT: Configure the Solr request handler to transform the 
		posted XML using a specified XSLT before trying to index the document. An XSLT file to transform an XML document (with root XML element &#8216;Auction&#8217;) is shown below:</li>
</ol>
<figure class='code'><figcaption><span>xmlToSolrDoc</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c">&lt;!-- the 2.0 version of xsl reqires a custom processor to be used. Saxon9he is used, and is</span>
</span><span class='line'><span class="c">located in Jetty&#39;s ext/ folder. This library requires Jetty to be started like so:</span>
</span><span class='line'><span class="c">java -Djavax.xml.transform.TransformerFactory=net.sf.saxon.TransformerFactoryImpl -jar start.jar</span>
</span><span class='line'><span class="c">--&gt;</span>
</span><span class='line'><span class="nt">&lt;xsl:stylesheet</span> <span class="na">version=</span><span class="s">&quot;2.0&quot;</span>
</span><span class='line'>                <span class="na">xmlns:xsl=</span><span class="s">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span>
</span><span class='line'>                <span class="na">xmlns:xs=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema&quot;</span>
</span><span class='line'>                <span class="na">xmlns:fn=</span><span class="s">&quot;http://www.w3.org/2005/xpath-functions&quot;</span>
</span><span class='line'>                <span class="na">xmlns:xdt=</span><span class="s">&quot;http://www.w3.org/2005/xpath-datatypes&quot;</span>
</span><span class='line'>                <span class="na">xmlns:err=</span><span class="s">&quot;http://www.w3.org/2005/xqt-errors&quot;</span>
</span><span class='line'>                <span class="na">xmlns:tm=</span><span class="s">&quot;http://api.trademe.co.nz/v1&quot;</span>
</span><span class='line'>                <span class="na">exclude-result-prefixes=</span><span class="s">&quot;xs xdt err fn tm&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;xsl:output</span> <span class="na">method=</span><span class="s">&quot;xml&quot;</span> <span class="na">indent=</span><span class="s">&quot;yes&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c">&lt;!-- &#39;Auction&quot; is the root XML element --&gt;</span>
</span><span class='line'>    <span class="nt">&lt;xsl:template</span> <span class="na">match=</span><span class="s">&quot;tm:Auction&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;add&gt;&lt;doc&gt;</span>
</span><span class='line'>                <span class="nt">&lt;xsl:for-each</span> <span class="na">select=</span><span class="s">&quot;//text()/.. intersect child::*&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>                    <span class="nt">&lt;field&gt;</span>
</span><span class='line'>                        <span class="nt">&lt;xsl:attribute</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>                            <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;name()&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>                        <span class="nt">&lt;/xsl:attribute&gt;</span>
</span><span class='line'>                        <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;.&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>                    <span class="nt">&lt;/field&gt;</span>
</span><span class='line'>                <span class="nt">&lt;/xsl:for-each&gt;</span>
</span><span class='line'>
</span><span class='line'>                <span class="nt">&lt;xsl:for-each</span> <span class="na">select=</span><span class="s">&quot;//text()/.. except child::*&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>                    <span class="nt">&lt;field&gt;</span>
</span><span class='line'>                        <span class="nt">&lt;xsl:attribute</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>                            <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;../name()&quot;</span><span class="nt">/&gt;</span>_<span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;name()&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>                        <span class="nt">&lt;/xsl:attribute&gt;</span>
</span><span class='line'>                        <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;.&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>                    <span class="nt">&lt;/field&gt;</span>
</span><span class='line'>                <span class="nt">&lt;/xsl:for-each&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/doc&gt;&lt;/add&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/xsl:template&gt;</span>
</span><span class='line'><span class="nt">&lt;/xsl:stylesheet&gt;</span>
</span></code></pre></td></tr></table></div></figure>
<h2>Indexing snares</h2>
<p>
	There are two issues I encountered for which I had trouble finding information online. Consider coming back to this section if you have issues with indexing or the DIH, and you might be in luck.
</p>
<h3>Letter case in the DIH configuration file</h3>
<p>
	Table and row names in the DIH configuration file are tediously case-sensitive-ish. Some places the case doesn&#8217;t matter, and other places it does. Where it does matter, the table and row names must be in the exact same form as in the database. Also, case must be internally consistent within the configuration file for most name usages.
</p>
<h3>Missing fields in posted XML and DIH mapping everything to the ignore field</h3>
<p>
	These two seemingly unrelated issues are linked by the presence of a dynamic field in <code>schema.xml</code>. When posting XML data, all fields defined in the schema file <strong>must be present</strong> in the XML file being posted. If there are fields in the XML document which are not used in the index, errors are throw when posting the XML. The way around this is to create a catch-all field:
	this schema field catches all fields in the document which have not been mapped to another field. This workaround, however, interferes with the operation of the DIH. The DIH, annoyingly, maps nearly all fields to the catch-all field. This may have something to do with the nice feature of the DIH which allows you to leave out every mapping from row-&gt;field if the row and field have the same name. Leaving out these mappings, however, seems to cause all fields to map to the catch-all ignore field. My current hack involves changing the <code class="inline-green-code">schema.xml</code> file every time I want to import documents using the DIH.
</p>

<h2>Searching</h2>
<p>
	Search requests are carried out by request handlers which parse and process searches. A good way to describe search handlers is through an example. The following is a search request handler I use:
</p>
<figure class='code'><figcaption><span>requestHandler.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;requestHandler</span> <span class="na">name=</span><span class="s">&quot;/broadQuery&quot;</span> <span class="na">class=</span><span class="s">&quot;solr.SearchHandler&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;lst</span> <span class="na">name=</span><span class="s">&quot;defaults&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;str</span> <span class="na">name=</span><span class="s">&quot;defType&quot;</span><span class="nt">&gt;</span>edismax<span class="nt">&lt;/str&gt;</span> <span class="c">&lt;!-- The search parser to use. --&gt;</span>
</span><span class='line'>        <span class="nt">&lt;str</span> <span class="na">name=</span><span class="s">&quot;wt&quot;</span><span class="nt">&gt;</span>xml<span class="nt">&lt;/str&gt;</span> <span class="c">&lt;!-- Output type. --&gt;</span>
</span><span class='line'>        <span class="nt">&lt;str</span> <span class="na">name=</span><span class="s">&quot;fl&quot;</span><span class="nt">&gt;</span>auction_id title<span class="nt">&lt;/str&gt;</span> <span class="c">&lt;!-- The fields to list in the search response --&gt;</span>
</span><span class='line'>        <span class="nt">&lt;str</span> <span class="na">name=</span><span class="s">&quot;qf&quot;</span><span class="nt">&gt;</span>Title^2 Feature<span class="nt">&lt;/str&gt;</span> <span class="c">&lt;!-- The fields (and their weightings) to search in.--&gt;</span>
</span><span class='line'>        <span class="nt">&lt;str</span> <span class="na">name=</span><span class="s">&quot;rows&quot;</span><span class="nt">&gt;</span>100<span class="nt">&lt;/str&gt;</span> <span class="c">&lt;!-- The number of results to return. --&gt;</span>
</span><span class='line'>        <span class="nt">&lt;str</span> <span class="na">name=</span><span class="s">&quot;pf&quot;</span><span class="nt">&gt;</span>Title^4 Feature^2<span class="nt">&lt;/str&gt;</span> <span class="c">&lt;!-- Phrase field (and their weightings). Fields to search for closely located matches. --&gt;</span>
</span><span class='line'>        <span class="nt">&lt;str</span> <span class="na">name=</span><span class="s">&quot;ps&quot;</span><span class="nt">&gt;</span>0<span class="nt">&lt;/str&gt;</span> <span class="c">&lt;!-- Phrase slop. How many tokens apart must words be to be able to qualify as a phrase--&gt;</span>
</span><span class='line'>        <span class="nt">&lt;str</span> <span class="na">name=</span><span class="s">&quot;echoParams&quot;</span><span class="nt">&gt;</span>all<span class="nt">&lt;/str&gt;</span> <span class="c">&lt;!-- Print the search settings in the search results. Just a handy feature --&gt;</span>
</span><span class='line'>        <span class="nt">&lt;str</span> <span class="na">name=</span><span class="s">&quot;mm&quot;</span><span class="nt">&gt;</span>3<span class="ni">&amp;lt;</span>-1 5<span class="ni">&amp;lt;</span>-2 6<span class="ni">&amp;lt;</span>-40%<span class="nt">&lt;/str&gt;</span>
</span><span class='line'>        <span class="c">&lt;!-- 3&gt;-1 5&gt;-2 6&gt;-40% Means: If there are 1-3 search terms, they are all required to</span>
</span><span class='line'><span class="c">        &lt;!-- match. If there are 4-5 search terms, then (all - 1) must match.</span>
</span><span class='line'><span class="c">        If there are 5-6 search terms, then (all -2) must match</span>
</span><span class='line'><span class="c">        If there are &gt;6 search terms, then (all - 40%) must match. --&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/lst&gt;</span>
</span><span class='line'><span class="nt">&lt;/requestHandler&gt;</span>
</span></code></pre></td></tr></table></div></figure>
<p>
	All these parameters can be specified at query time also; defining them within the request handler definition simply specifies defaults. To use this search handler I would navigate/send request to:
</p>
<p>
	<a href="http://localhost:8983/solr/auctions/broadQuery?q=dell+monitor+IPS">http://localhost:8983/solr/auctions/broadQuery?q=dell+monitor+IPS</a>
	<br/>
	<span class='note'>
		(Assuming that &#8216;auctions&#8217; is the name of your Solr core, and Solr is hosted on localhost)
	</span>
</p>

<p>While most of the search handler&#8217;s configuration can be understood from the comments, defType, pf, ps and mm might need further explanation:
</p>
<dl>
	<dt>defType</dt>
	<dd>defType specifies the search parser to use. There are a number of popular search parsers including <a href="https://cwiki.apache.org/confluence/display/solr/The+Standard+Query+Parser" target="_blank">Standard Search</a>,<a href="https://cwiki.apache.org/confluence/display/solr/The+DisMax+Query+Parser" target="_blank">DisMax</a> and <a href="https://cwiki.apache.org/confluence/display/solr/The+Extended+DisMax+Query+Parser" target="_blank">eDisMax</a>. eDismax combines the features of both the Standard Search and DisMax; eDisMax supports the full query syntax of the Lucene Standard Query, but is far more tolerant of syntax errors. eDismax seems like the obvious choice in most circumstances.</dd>
	<dt>pf</dt>
	<dd>pf (phase fields) specifies what fields should be checked for having matching &#8216;phrases&#8217;. If matching terms are close enough together, then they can be considered a phrase. A result with a matching phrase will score higher than one with no matching phase. You can also specify a weighting: a field weighting will control the effect of a match on the match&#8217;s score. For example, a phrase found in the title will score higher that one found in feature.</dd>
	<dt>ps</dt>
	<dd>ps (phrase slop) specifies how many terms can be in-between two matching terms and still allow the matching terms to be considered a matching phrase.</dd>
</dl>

<h2>Searching from Java</h2>
<p>
	Searching can be carried out from Java with the use of <a href="https://wiki.apache.org/solr/Solrj" target="_blank">SolrJ</a>. The gist below shows a very simple method utilizing SolrJ:
</p>
<figure class='code'><figcaption><span>Search.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleSolrSearch</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">String</span> <span class="n">solrUrl</span> <span class="o">=</span> <span class="s">&quot;http://192.168.1.103:8983/solr/auctions&quot;</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">SolrServer</span> <span class="n">server</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">SimpleSolrSearch</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpSolrServer</span><span class="o">(</span><span class="n">solrUrl</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="nf">search</span><span class="o">(</span><span class="n">String</span> <span class="n">searchTerms</span><span class="o">,</span> <span class="n">String</span> <span class="n">category</span><span class="o">,</span> <span class="n">BigDecimal</span> <span class="n">maxBidAmount</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SolrServerException</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">SolrQuery</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SolrQuery</span><span class="o">();</span>
</span><span class='line'>        <span class="n">String</span> <span class="n">categoryFilter</span> <span class="o">=</span> <span class="s">&quot;category:\&quot;&quot;</span> <span class="o">+</span> <span class="n">category</span> <span class="o">+</span> <span class="s">&quot;\&quot;&quot;</span><span class="o">;</span>
</span><span class='line'>        <span class="n">query</span><span class="o">.</span><span class="na">addFilterQuery</span><span class="o">(</span><span class="n">categoryFilter</span><span class="o">);</span>
</span><span class='line'>        <span class="n">query</span><span class="o">.</span><span class="na">addFilterQuery</span><span class="o">(</span><span class="s">&quot;current_bid:[1 TO &quot;</span> <span class="o">+</span> <span class="n">maxBidAmount</span><span class="o">.</span><span class="na">doubleValue</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">query</span><span class="o">.</span><span class="na">setQuery</span><span class="o">(</span><span class="n">searchTerms</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">QueryResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">query</span><span class="o">);</span>
</span><span class='line'>        <span class="n">SolrDocumentList</span> <span class="n">documentList</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getResults</span><span class="o">();</span>
</span><span class='line'>        <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">auctionIds</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span><span class='line'>        <span class="k">for</span><span class="o">(</span><span class="n">SolrDocument</span> <span class="n">doc</span> <span class="o">:</span> <span class="n">documentList</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="kt">int</span> <span class="n">listingId</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">((</span><span class="n">String</span><span class="o">)</span><span class="n">doc</span><span class="o">.</span><span class="na">getFirstValue</span><span class="o">(</span><span class="s">&quot;auction_id&quot;</span><span class="o">));</span>
</span><span class='line'>            <span class="n">auctionIds</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">listingId</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">auctionIds</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<h2>Further reading</h2>
<p>
	I have briefly covered many common tasked carried out when using Solr. There are many more features: search faceting, search clustering, distributed searches and index replication to name a few. There are many comprehensive sources available. Some useful sources I would suggest:
</p> 
<ul>
	<li><a href="http://www.amazon.com/gp/product/1617291021/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=1617291021&linkCode=as2&tag=kevidoraprog-20&linkId=WHTDMHU3HOMEGTUP" target="_blank">Solr in Action</a></li>
	<li><a href="https://cwiki.apache.org/confluence/display/solr/Apache+Solr+Reference+Guide" target="_blank">Lucid Works&#8217; Solr Reference Guide</a></li>
	<li><a href="http://www.amazon.com/gp/product/193398838X/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=193398838X&linkCode=as2&tag=kevidoraprog-20&linkId=FGBKCGZ6BOOMWOGZ" target="_blank">Taming Text</a> (practical guide for all types of text searching and manipulations)</li>
	<li><a href="http://www.amazon.com/gp/product/1933988177/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=1933988177&amp;linkCode=as2&amp;tag=kevidoraprog-20" target="_blank">Lucene in Action, 2nd Edition</a> (if you want to go to a lower level than Solr)</li>
	<li><a href="http://www.amazon.com/gp/product/1935182854/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=1935182854&amp;linkCode=as2&amp;tag=kevidoraprog-20" target="_blank">Tika in Action</a> (if you want to index and search documents such as PDFs)</li>
</ul>



        <hr class="divider-short"/>
        
          <div>
            <h1>Comments</h1>
            <div id="disqus_thread" aria-live="polite">

<script type="text/javascript">
      var disqus_shortname = 'kevio';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://kevindoran.github.io/blog/2014/06/04/solr-tutorial/';
        var disqus_url = 'http://kevindoran.github.io/blog/2014/06/04/solr-tutorial/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>

</div>
          </div>
        
      </div>
    </div>
  </div>
</article>



<div class="archive-link">
  <div class="container">
    <div class="row">
      <div class="col-md-8 col-md-offset-2">
        
          <a class="pull-left" href="/blog/2013/04/21/bluetooth-programming-with-python-3/" title="Previous Post: Bluetooth Programming with Python 3">&laquo; Previous: Bluetooth Programming with Python 3</a>
        

        
          <a class="pull-right" href="/blog/2014/06/07/how-java-ee-is-the-charizard-of-web-frameworks/" title="Next Post: How Java EE is the Charizard of Web Frameworks">Next: How Java EE is the Charizard of Web Frameworks &raquo;</a>
        
      </div>
    </div>
  </div>
</div>

    <footer id="footer" class="her-row">
  <div class="container">
    <div class="row">
      <div class="col-md-1">
  <a href="/"><h4>Home</h4></a>
</div>

<div class="col-md-2">
  <div class="social-icon-list">
    
    <a href="https://twitter.com/DoranK2"><img src="/images/glyphicons_social_31_twitter.png"/></a>
    

    
    <a href="https://github.com/kevindoran"><img src="/images/glyphicons_social_21_github.png"/></a>
    

    
  </div>
</div>

<div class="pull-right">
  <h4>Powered by <a href="http://octopress.org/">Octopress</a>. Design forked from <a href="http://AdrianArtiles.com">Adrian Artiles</a>.</h4>
</div>


    </div>
  </div>
</footer>

  </body>
</html>
